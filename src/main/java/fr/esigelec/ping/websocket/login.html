<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion</title>
</head>
<body>
    <h2>Connexion</h2>

    <form id="loginForm">
        <label for="email">Email :</label>
        <input type="email" id="email" name="email" required><br><br>

        <label for="password">Mot de passe :</label>
        <input type="password" id="password" name="password" required><br><br>

        <button type="submit">Se connecter</button>
    </form>

    <p id="message"></p>

    <script>
        const BASE_URL = "http://localhost:5000/api";
        let webSocket;

        document.getElementById("loginForm").addEventListener("submit", async function (event) {
            event.preventDefault();

            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            try {
                const response = await fetch(`${BASE_URL}/users/connexion`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById("message").textContent = `âœ… Connexion rÃ©ussie ! Bienvenue ${data.username}`;
                    
                    console.log("Connexion rÃ©ussie :", data);

                    // ðŸ”„ RÃ©cupÃ©rer les conversations et s'abonner via WebSocket
                    fetchUserConversations(data.id);

                } else {
                    const errorData = await response.json();
                    document.getElementById("message").textContent = `âŒ Erreur : ${errorData.message || 'Identifiants invalides'}`;
                }
            } catch (error) {
                console.error("Erreur lors de la connexion :", error);
                document.getElementById("message").textContent = "âŒ Erreur de connexion au serveur.";
            }
        });

        // ðŸ“¥ RÃ©cupÃ©rer les conversations de l'utilisateur
        async function fetchUserConversations(userId) {
            try {
                const response = await fetch(`${BASE_URL}/conversations/user/${userId}`);
                const conversations = await response.json();

                console.log("Conversations rÃ©cupÃ©rÃ©es :", conversations);

                // ðŸ”Œ Connexion au WebSocket
                connectWebSocket(conversations);

            } catch (error) {
                console.error("Erreur lors de la rÃ©cupÃ©ration des conversations :", error);
            }
        }

        // ðŸ“¡ Connexion au WebSocket et abonnement
        function connectWebSocket(conversations) {
            webSocket = new WebSocket("ws://localhost:5000/ws");

            webSocket.onopen = () => {
                console.log("âœ… ConnectÃ© au WebSocket");

                // ðŸ”” Abonnement Ã  chaque conversation
                conversations.forEach(conversation => {
                    const subscribeMessage = {
                        action: "subscribe",
                        conversationId: conversation.id
                    };

                    webSocket.send(JSON.stringify(subscribeMessage));
                    console.log(`ðŸ“¢ AbonnÃ© Ã  la conversation ${conversation.id}`);
                });
            };

            webSocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log("ðŸ“¥ Nouveau message reÃ§u :", data);
            };

            webSocket.onerror = (error) => {
                console.error("Erreur WebSocket :", error);
            };

            webSocket.onclose = () => {
                console.warn("ðŸ”Œ Connexion WebSocket fermÃ©e");
            };
        }
    </script>
</body>
</html>
