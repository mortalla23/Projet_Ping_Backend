<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Messagerie WebSocket</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px; }
        #messages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; background-color: #fff; }
        input, button { padding: 10px; margin-top: 10px; }
        #status { margin-top: 10px; color: green; }
    </style>
</head>
<body>

<h2>ğŸ’¬ Messagerie WebSocket</h2>

<label for="conversationId">ID de la Conversation :</label>
<input type="number" id="conversationId" placeholder="Entrez l'ID de la conversation" />

<button onclick="connect()">ğŸ”— Se connecter</button>
<div id="status">âš ï¸ Non connectÃ©</div>

<h3>Messages :</h3>
<div id="messages"></div>

<input type="text" id="messageInput" placeholder="Tapez votre message..." />
<button onclick="sendMessage()">ğŸ“¤ Envoyer</button>

<script>
    let socket;

    // âœ… Connexion WebSocket et abonnement Ã  une conversation
    function connect() {
        const conversationId = document.getElementById("conversationId").value;

        if (!conversationId) {
            alert("Veuillez entrer un ID de conversation.");
            return;
        }

        socket = new WebSocket("ws://localhost:5000/ws");

        socket.onopen = () => {
            document.getElementById("status").textContent = "ğŸŸ¢ ConnectÃ© au WebSocket";
            console.log("âœ… ConnectÃ© au WebSocket");

            // ğŸ”” S'abonner Ã  la conversation
            const subscribeMessage = JSON.stringify({
                action: "subscribe",
                conversation_id: parseInt(conversationId)
            });
            socket.send(subscribeMessage);
            console.log("ğŸ“© Abonnement Ã  la conversation :", subscribeMessage);
        };

        socket.onmessage = (event) => {
            console.log("ğŸ“¥ Message reÃ§u :", event.data);
            const messageData = JSON.parse(event.data);

            // ğŸ“Œ Affiche le message dans la messagerie
            const messagesDiv = document.getElementById("messages");
            messagesDiv.innerHTML += `<p><strong>${messageData.sender || "Utilisateur"}:</strong> ${messageData.content}</p>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;  // Scroll automatique
        };

        socket.onerror = (error) => {
            console.error("âŒ Erreur WebSocket :", error);
            document.getElementById("status").textContent = "ğŸ”´ Erreur de connexion";
        };

        socket.onclose = () => {
            console.warn("ğŸ”’ Connexion fermÃ©e");
            document.getElementById("status").textContent = "ğŸ”´ Connexion fermÃ©e";
        };
    }

    // ğŸ“¤ Envoyer un message via WebSocket
    function sendMessage() {
        const conversationId = document.getElementById("conversationId").value;
        const content = document.getElementById("messageInput").value;

        if (socket && socket.readyState === WebSocket.OPEN) {
            const message = JSON.stringify({
                action: "send_message",
                conversation_id: parseInt(conversationId),
                content: content
            });
            socket.send(message);
            console.log("ğŸ“¤ Message envoyÃ© :", message);
            document.getElementById("messageInput").value = "";  // RÃ©initialise l'input
        } else {
            alert("Vous n'Ãªtes pas connectÃ© au WebSocket.");
        }
    }
</script>

</body>
</html>
