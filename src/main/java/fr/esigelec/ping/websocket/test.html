<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Messagerie WebSocket</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px; }
        #messages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; background-color: #fff; }
        input, button { padding: 10px; margin-top: 10px; }
        #status { margin-top: 10px; color: green; }
    </style>
</head>
<body>

<h2>💬 Messagerie WebSocket</h2>

<label for="conversationId">ID de la Conversation :</label>
<input type="number" id="conversationId" placeholder="Entrez l'ID de la conversation" />

<button onclick="connect()">🔗 Se connecter</button>
<div id="status">⚠️ Non connecté</div>

<h3>Messages :</h3>
<div id="messages"></div>

<input type="text" id="messageInput" placeholder="Tapez votre message..." />
<button onclick="sendMessage()">📤 Envoyer</button>

<script>
    let socket;

    // ✅ Connexion WebSocket et abonnement à une conversation
    function connect() {
        const conversationId = document.getElementById("conversationId").value;

        if (!conversationId) {
            alert("Veuillez entrer un ID de conversation.");
            return;
        }

        socket = new WebSocket("ws://localhost:5000/ws");

        socket.onopen = () => {
            document.getElementById("status").textContent = "🟢 Connecté au WebSocket";
            console.log("✅ Connecté au WebSocket");

            // 🔔 S'abonner à la conversation
            const subscribeMessage = JSON.stringify({
                action: "subscribe",
                conversation_id: parseInt(conversationId)
            });
            socket.send(subscribeMessage);
            console.log("📩 Abonnement à la conversation :", subscribeMessage);
        };

        socket.onmessage = (event) => {
            console.log("📥 Message reçu :", event.data);
            const messageData = JSON.parse(event.data);

            // 📌 Affiche le message dans la messagerie
            const messagesDiv = document.getElementById("messages");
            messagesDiv.innerHTML += `<p><strong>${messageData.sender || "Utilisateur"}:</strong> ${messageData.content}</p>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;  // Scroll automatique
        };

        socket.onerror = (error) => {
            console.error("❌ Erreur WebSocket :", error);
            document.getElementById("status").textContent = "🔴 Erreur de connexion";
        };

        socket.onclose = () => {
            console.warn("🔒 Connexion fermée");
            document.getElementById("status").textContent = "🔴 Connexion fermée";
        };
    }

    // 📤 Envoyer un message via WebSocket
    function sendMessage() {
        const conversationId = document.getElementById("conversationId").value;
        const content = document.getElementById("messageInput").value;

        if (socket && socket.readyState === WebSocket.OPEN) {
            const message = JSON.stringify({
                action: "send_message",
                conversation_id: parseInt(conversationId),
                content: content
            });
            socket.send(message);
            console.log("📤 Message envoyé :", message);
            document.getElementById("messageInput").value = "";  // Réinitialise l'input
        } else {
            alert("Vous n'êtes pas connecté au WebSocket.");
        }
    }
</script>

</body>
</html>
